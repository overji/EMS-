# 一、项目架构

## 1. 文件夹概述

在主文件夹下有文件：

- `main.py`：主程序入口
- `mainui.py`：主界面
- `mainUi.ui`：主菜单界面

及文件夹：

- data：
    - `data_db.db`：数据库文件
    - `user_data.db`：测试数据
    - `data_input.py`：从.csv文件导入数据到`data_db.db`
- pictures：存放图片
    - backimage:背景图片
    - button_image：按钮图片
    - Figures：绘图接口生成的图片
- ChildPages：
    - `xxx.py`，`xxx.ui`：七个子页面的ui文件及py接口
    - ChildPageBase.py: 所有子页面接口类的基类
    - *此外还有一个`__init__.py`文件，用于标识该目录是一个包*
- SignUp:
    - `mainlog.py`：登录界面程序接口
    - `denglu.ui`,`zhuce.ui`,`zhaohui.ui`：登录，注册，找回密码界面ui
    - `text.py`：运行以查询现有的用户数据

## 2. 界面概述

- 打开`main.py`，进入程序
- 若在`main.py`中解除对于`signIn(1)`语句的注释，则跳过登录直接打开主界面
- 主界面中依次有以下七个子页面：
    - 主界面图
    - 网络界面
    - 风电系统
    - 光伏系统
    - 电动汽车
    - 储能系统
    - 负荷系统
- 此外，左上角T/P为开始刷新和暂停刷新，右上角×为退出，-为最小化

## 3. 命名和编程规范

- 命名规范
    <!--已经不是很好用了，需要更新-->
    1. 文件夹命名：
    2. 文件命名：统一命名为`xxxx.py`，如`wind.py`, `solar.py`。
    3. 文件内类的命名：统一命名为`Xxxx_Ui`，如`Wind_Ui`, `Solar_Ui`。
    4. 其余命名随意，主文件大概率用不到。
       <br>

- 编程规范
    1. 路径引用：统一使用以Project为根目录的相对路径。如引用数据库时使用路径`data/data_db.db`。
    2. 类的__init__()方法中，统一传入一个参数`relative_path=None`用于设定类的成员变量`relative_path`
       ，并在类的其他方法中使用`self.relative_path + "路径/路径"`来引用自身所在路径。（自己测试的时候）<!--但是貌似已经不好用了-->
- 字体大小规范：未指定（这也是问题所在喵）
  <br>

## 4.遗传算法相关

### 1. 优化目标

考虑风能发电 $PV$ ，光伏发电 $WT$ ，用电载荷 $Load$ ，储能模块充电/放电 $bat_E$ ，电动汽车用电 $car_E$ ，电网输出/流入电量
$grid_P$     
总共的消耗 = 电网购电成本/售电收入 - 风力发电收入 -汽车充电收入 - 光伏发电收入 + 储能超标惩罚 + 汽车用电超标惩罚       
优化目标是使得总共消耗最低

### 2. 约束条件

风能发电 $PV$ ，光伏发电 $WT$ ，用电载荷 $Load$ ，储能模块充电/放电 $bat_E$ ，电动汽车用电 $car_E$ ，电网输出/流入电量
$grid_P$

+ 有 $PV + WT + bat_E + grid_P = Load + car_E$
+ 同时 $0.4* bat_{Emax} \le bat_{E0} \le bat_{Emax}$
+ 同时 $0 \le car_{E0} \le car_{Emax}$
+ 同时蓄电池电量 $bat_{E0}$ 存在损耗，每小时 $0.01\%$
+ 同时汽车每小时用电量在 $0\sim 50$ 之间
+ 同时蓄电池充(放)电量在 $-50\sim 50$ 之间


## 3. 数据库
数据库部署在阿里云的服务器上，一般不会关闭  
数据库现在使用MySQL  
### 3.1 数据库信息:
+ IP: 112.124.43.86
+ 端口: 3306
+ 用户: EMS
+ 数据库名称: ems
+ 数据库所用的表: EMS_Data

### 3.2 常用语句:
连接数据库:`engine = create_engine('mysql+mysqlconnector://EMS:282432@112.124.43.86/ems')`  
数据库信息写入DataFrame: 
```
    query = "SELECT * FROM EMS_Data"
    df = pd.read_sql(query,engine)
```


# 二、项目日志

### 2024.3.29，版本0.7.6

1. 项目文件架构整理（除登录界面外已完成）
2. 统一规范未完成

### 2024.5.29，版本0.8.2

1. 更新了风能和光伏发电的ui，取消了电价的图表

### 2024.5.29，版本0.8.3

1. 将登录界面整合入主程序，以后运行main.py即可运行程序

### 2024.6.2，版本0.8.4

1. 将遗传算法计算储能充放电情况得到的结果整合到了数据库和页面中
2. 更新了wind, storage, solar, EV, load的全局字体大小和样式设置（界面.py文件）
3. 更新了Network网络界面，但没有任何功能

### 2024.6.2 use_QTimer 分支

1. 使用QTiner实现了顺利关闭，但是没有实现多线程运算，所以运算时候会很卡

### 2024.6.18，版本0.8.5

1. 添加了汽车的调度
2. 现在程序不会关闭时卡死了
3. 现在下载时应该不会报错了，上传了新的数据库
4. 调整了汽车、储能的画图，修改了风力、光伏的横轴的坐标。
5. 更新了主界面Main_Page，点击左侧图片可以更新右侧数据
6. 意识到部分文件被覆盖，部分进度丢失，但只恢复了一部分进度，嗯嗯

### 2024.6.19 版本0.8.6

1.主页可以正常显示信息

### 2024.8.29 版本0.9.0

1. 整理了main.py，mainlog.py，mainui.py等多个py文件，降低其耦合性
2. 将多线程任务和登录成功判定等功能放进`main.py`，从而简化`mainui.py`
3. 整理了文件夹
    1. 将自己写的脚本和遗传算法脚本放入APIs文件夹中
    2. 将页面和页面接口放入ChildPages文件夹中
    3. 整理了SignUp文件夹
4. 对主界面的ui进行了调整，将其整合为一个`mainUi.ui`文件，从而使可以可视化编辑
5. 下一步任务TODO
    - 登录界面这三个界面的ui更改：避免控件位置错误
    - 各个子页面的ui风格、字体大小、样式表等统一化
    - mainPage组织结构更改
    - 将绘图制作成一个api
    - 是否有必要将计时器放在main.py中处理呢？

### 2024.9.4 版本0.9.1

1. 整理了子页面，现在所有子页面继承自ChildPage基类（请记得重写必要的方法）
2. 为代码添加了注释，修改了部分代码，使其更简洁
3. 修改了部分子页面的ui，为根控件Form设置布局，这样就不需要在代码中重新设置布局
4. 将图片绘制分离为`APIs/FigureDraw.py`中的接口，子页面中代码得以简化。此外，绘制的图片不再存储在`ChildPages/pictures`
   下，而是存储在`pictures/Figures`下
5. 请保持良好的码风，不要用单个字母命名变量，不要不写注释，不要调用零值列表的随机元素，不要将随便什么变量都写成类的成员变量，etc.
6. TODO
    - 登录界面这三个界面的ui更改，以避免控件位置错误
    - 设计ui，并更改各个子页面的ui风格、字体大小、样式表等统一化
    - 是否有必要将计时器放在main.py中处理呢？
    - 由于相对路径设置麻烦，所以考虑是否需要公用main.py的路径，子页面不再单独设置路径；子页面的调试通过启动main.py来执行
    -
    将主页面的按钮更改为不规则形状碰撞体积，见[QT不规则形状的按钮的实现](https://blog.csdn.net/thanklife/article/details/122215309)

### 2024.10.9版本0.9.1 - Cloud分支
1. 将数据库放到了云端，使用mysql数据库
2. 上传了但是没有完全上传，登陆界面等过几天再搞
3. 现在页面极其卡顿，后面需要限制一下读取数据库的频率
4. 现在天气读取出现了bug，后面再修改
5. 新建了gitignore文件，不要把奇怪的文件放进git里面去(，并且使用
`git add .gitignore`替代以前习惯用的`git add .`

### 2024.10.27版本0.9.2 - main分支
1. 把数据计算放到了云端
2. 修复了天气读取功能